@{
    ViewData["Title"] = "Departments";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Departments</h1>
    <button type="button" class="btn btn-primary" id="addDepartmentBtn" title="Add">
        <i class="bi bi-plus-circle"></i>
    </button>
</div>

<div id="departmentListContainer" aria-live="polite" aria-busy="true">
    <div class="text-center py-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<div class="modal fade" id="departmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content"></div>
    </div>
</div>

<div class="modal fade" id="departmentDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content"></div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const listContainer = document.getElementById("departmentListContainer");
            const modalElement = document.getElementById("departmentModal");
            const deleteModalElement = document.getElementById("departmentDeleteModal");
            const departmentModal = new bootstrap.Modal(modalElement);
            const deleteModal = new bootstrap.Modal(deleteModalElement);

            const setModalContent = (element, html) => {
                element.querySelector('.modal-content').innerHTML = html;
            };

            const loadList = () => {
                listContainer.setAttribute("aria-busy", "true");
                fetch('@Url.Action("List")')
                    .then(response => response.text())
                    .then(html => {
                        listContainer.innerHTML = html;
                        listContainer.setAttribute("aria-busy", "false");
                        attachRowHandlers();
                    })
                    .catch(() => {
                        listContainer.innerHTML = '<div class="alert alert-danger">Unable to load departments.</div>';
                        listContainer.setAttribute("aria-busy", "false");
                    });
            };

            const bindFormSubmission = (form, element, modalInstance) => {
                if (!form) {
                    return;
                }

                form.addEventListener("submit", event => {
                    event.preventDefault();
                    const formData = new FormData(form);
                    fetch(form.action, {
                        method: form.method,
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => {
                            const contentType = response.headers.get("content-type") || "";
                            if (contentType.includes("application/json")) {
                                return response.json();
                            }
                            return response.text().then(html => ({ html }));
                        })
                        .then(result => {
                            if (result.success) {
                                modalInstance.hide();
                                loadList();
                            } else if (result.html) {
                                setModalContent(element, result.html);
                                bindFormSubmission(element.querySelector('form'), element, modalInstance);
                            }
                        })
                        .catch(() => {
                            setModalContent(element, '<div class="modal-body text-danger">An unexpected error occurred.</div>');
                        });
                }, { once: true });
            };

            const openFormModal = url => {
                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        setModalContent(modalElement, html);
                        departmentModal.show();
                        bindFormSubmission(modalElement.querySelector('form'), modalElement, departmentModal);
                    })
                    .catch(() => {
                        setModalContent(modalElement, '<div class="modal-body text-danger">Unable to load the form.</div>');
                        departmentModal.show();
                    });
            };

            const openDeleteModal = url => {
                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        setModalContent(deleteModalElement, html);
                        deleteModal.show();
                        const form = deleteModalElement.querySelector('form');
                        if (form) {
                            form.addEventListener('submit', event => {
                                event.preventDefault();
                                const formData = new FormData(form);
                                fetch(form.action, {
                                    method: form.method,
                                    body: formData,
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest'
                                    }
                                })
                                    .then(response => response.json())
                                    .then(result => {
                                        if (result.success) {
                                            deleteModal.hide();
                                            loadList();
                                        }
                                    })
                                    .catch(() => {
                                        setModalContent(deleteModalElement, '<div class="modal-body text-danger">Unable to delete the department.</div>');
                                    });
                            }, { once: true });
                        }
                    })
                    .catch(() => {
                        setModalContent(deleteModalElement, '<div class="modal-body text-danger">Unable to load the confirmation dialog.</div>');
                        deleteModal.show();
                    });
            };

            const attachRowHandlers = () => {
                listContainer.querySelectorAll('[data-action="edit"]').forEach(button => {
                    button.addEventListener('click', () => openFormModal(button.dataset.url));
                });

                listContainer.querySelectorAll('[data-action="delete"]').forEach(button => {
                    button.addEventListener('click', () => openDeleteModal(button.dataset.url));
                });
            };

            document.getElementById('addDepartmentBtn').addEventListener('click', () => {
                openFormModal('@Url.Action("Create")');
            });

            loadList();
        });
    </script>
}

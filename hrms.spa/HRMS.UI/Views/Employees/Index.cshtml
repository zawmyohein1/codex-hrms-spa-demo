@model EmployeesIndexViewModel
@{
    ViewData["Title"] = "Employees";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0"><i class="bi bi-people-fill me-2"></i>Employees</h2>
    <button type="button"
            class="btn btn-outline-primary"
            data-modal-url="@Url.Action("Create")"
            data-modal-target="#modalForm"
            aria-label="Add employee">
        <i class="bi bi-plus-circle"></i>
    </button>
</div>

<form id="employee-filter-form" class="row g-3 align-items-end mb-4" autocomplete="off">
    <div class="col-md-3">
        <label for="searchEmpNo" class="form-label">Employee No</label>
        <input type="text" class="form-control" id="searchEmpNo" name="searchEmpNo" />
    </div>
    <div class="col-md-3">
        <label for="searchEmpName" class="form-label">Employee Name</label>
        <input type="text" class="form-control" id="searchEmpName" name="searchEmpName" />
    </div>
    <div class="col-md-3">
        <label for="departmentId" class="form-label">Department</label>
        <select class="form-select" id="departmentId" name="departmentId" asp-items="Model.Departments">
            <option value="">All Departments</option>
        </select>
    </div>
    <div class="col-md-3">
        <label for="occupationId" class="form-label">Occupation</label>
        <select class="form-select" id="occupationId" name="occupationId" asp-items="Model.Occupations">
            <option value="">All Occupations</option>
        </select>
    </div>
    <div class="col-12 d-flex gap-2">
        <button type="submit" class="btn btn-primary">Apply Filters</button>
        <button type="button" class="btn btn-outline-secondary" id="employee-reset">Reset</button>
    </div>
</form>

<div id="employee-list" class="table-responsive"></div>

<div class="modal fade" id="modalForm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content"></div>
    </div>
</div>

<div class="modal fade" id="modalDetails" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content"></div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(function () {
            const listContainer = '#employee-list';
            const listUrl = '@Url.Action("List")';
            let currentPage = 1;

            function buildQuery(pageNo) {
                const formData = $('#employee-filter-form').serializeArray();
                if (pageNo) {
                    formData.push({ name: 'pageNo', value: pageNo });
                }
                return $.param(formData);
            }

            function loadList(pageNo) {
                if (!pageNo) {
                    pageNo = currentPage;
                }

                const query = buildQuery(pageNo);
                const url = query ? `${listUrl}?${query}` : listUrl;

                $(listContainer).load(url, function () {
                    const meta = $(listContainer).find('[data-current-page]');
                    if (meta.length) {
                        const pageValue = parseInt(meta.data('current-page'), 10);
                        if (!Number.isNaN(pageValue)) {
                            currentPage = pageValue;
                        }
                    } else {
                        currentPage = pageNo;
                    }
                });
            }

            $('#employee-filter-form').on('submit', function (event) {
                event.preventDefault();
                loadList(1);
            });

            $('#employee-reset').on('click', function () {
                const form = $('#employee-filter-form')[0];
                if (form) {
                    form.reset();
                }

                loadList(1);
            });

            $(listContainer).on('click', '[data-page]', function (event) {
                event.preventDefault();
                const pageNo = $(this).data('page');
                if (pageNo) {
                    loadList(pageNo);
                }
            });

            $(document).on('submit', '.employee-ajax-form', function (event) {
                event.preventDefault();
                const form = this;
                const $form = $(form);
                const modalElement = $form.closest('.modal');
                const formData = new FormData(form);

                $.ajax({
                    url: $form.attr('action'),
                    type: $form.attr('method'),
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response, status, xhr) {
                        const contentType = xhr.getResponseHeader('content-type') || '';
                        if (contentType.indexOf('application/json') !== -1) {
                            if (response && response.success) {
                                if (modalElement.length) {
                                    const modalInstance = bootstrap.Modal.getInstance(modalElement[0]);
                                    if (modalInstance) {
                                        modalInstance.hide();
                                    }
                                }

                                loadList();
                            }
                        } else {
                            $form.closest('.modal-content').html(response);
                        }
                    },
                    error: function () {
                        alert('An unexpected error occurred.');
                    }
                });
            });

            loadList(1);
        });
    </script>
}
